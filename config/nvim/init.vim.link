" My neovim config file

call plug#begin('~/.vim/plugged')
" === Visuals ===
    Plug 'vim-airline/vim-airline'                    " Lean & mean status/tabline for vim that's light as air
    Plug 'vim-airline/vim-airline-themes'             " Themes for vim-airline
    Plug 'crusoexia/vim-monokai'                      " Monokai colorscheme
    Plug 'haishanh/night-owl.vim'                     " Awesome Night-owl theme by Sarah Drasner
    Plug 'junegunn/goyo.vim'                          " Distraction free writing in vim
    Plug 'preservim/nerdtree'                         " A tree explorer for vim

" === Brains ===
    Plug 'ctrlpvim/ctrlp.vim'                         " Fuzzy file, buffer, mru, tag, etc. finder
    Plug 'dense-analysis/ale'                         " Asynchronous linting and syntax checking
    Plug 'neoclide/coc.nvim', { 'branch': 'release' } " Intellisense engine form vim8 & neovim, full lsp as vscode
    " Install coc-plugins with :CocInstall <plugin-name> 
    " Install as required
    " Ex: :CocInstall coc-snippets
    " neoclide/coc-snippets 
    " neoclide/coc-lists     
    " neoclide/coc-json

" === Tmux ===
    Plug 'christoomey/vim-tmux-navigator'             " Seamless navigation between tmux panes and vim splits

" === Tags ===
    "Plug 'ludovicchabant/vim-gutentags'               " A vim plugin that manages your tag files
    "Plug 'xolox/vim-easytags'                         " Syntax highlighting and tag generation 
    "Plug 'xolox/vim-misc'                             " Required by vim-easytags
  
" === Nice to haves ===
    Plug 'jiangmiao/auto-pairs'                       " Vim plugin to insert or delete brackets, parens, quotes in air
    Plug 'junegunn/vim-easy-align'                    " Simple, easy-to-use vim-alignment plugin
    Plug 'tpope/vim-surround'                         " Quoting / parenthesizing made simple
    Plug 'preservim/nerdcommenter'                    " Vim plugin for intensely nerdy commenting powers

call plug#end()

" === General settings ===
    let g:python3_host_prog = '/usr/local/bin/python3' " Python for neovim
    set encoding=UTF-8
    set splitbelow     " Open horizontal splits at bottom
    set splitright     " Open vertical splits at right
    " For coc.vim
    set updatetime=300        " Having longer update times lead to poor UX
    set shortmess+=c          " Don't pass messages to |ins-completion-menu|
    set signcolumn=yes        " Always show the signcolumn, otherwise it would shift the text each time diagnostics appear/become resolved.
    set clipboard=unnamedplus " Map system keyboard to vim's paste buffer

" === Colorscheme ===
    if (has("termguicolors"))
        set termguicolors
    endif
    syntax enable
    colorscheme night-owl
    set cursorline " Highlighting that moves with the cursor

" === Spacing & Indentation ===
    filetype plugin indent on
    set backspace=indent,eol,start confirm
    set shiftwidth=4 autoindent smartindent tabstop=4 softtabstop=4 expandtab
    set cmdheight=1

" === Line Numbering ===
    set number
    " Toggle relative numbering, and set to absolute on loss of focus or insert mode
    autocmd InsertEnter * :set nornu
    autocmd InsertLeave * :set rnu
    " Disable relative numbering while debugging - when source window loses focus
    autocmd BufLeave * :set nornu
    autocmd BufEnter * cal SetRNU()
    function! SetRNU()
      if(mode() != 'i')
          set rnu
      endif 
    endfunction 

" === Folds ===
    set foldmethod=indent   " Fold based on indent
    set foldnestmax=3       " Deepest fold is 3 levels
    set nofoldenable        " Don't fold by default

" === Fix annoyances ===
    " To auto-close the method-preview window
    autocmd InsertLeave,CompleteDone * if pumvisible() == 0 | pclose | endif
    " Diable auto-comment
    " https://vim.fandom.com/wiki/Disable_automatic_comment_insertion
    autocmd FileType * setlocal formatoptions-=c formatoptions-=r formatoptions-=o

" === Searching ===
    " Ignorecase when searching
    set ignorecase
    " Incremental search - Vim starts searching when we start typing
    set incsearch
    " When searching try to be smart about cases
    set smartcase
    " Highlight search results
    set hlsearch
    " Stuff to ignore when tab completing
    set wildoptions=pum
    set wildignore=*.o,*.obj,*~                                                     
    set wildignore+=*.git*
    set wildignore+=*.meteor*
    set wildignore+=*vim/backups*
    set wildignore+=*sass-cache*
    set wildignore+=*mypy_cache*
    set wildignore+=*__pycache__*
    set wildignore+=*cache*
    set wildignore+=*logs*
    set wildignore+=*node_modules*
    set wildignore+=**/node_modules/**
    set wildignore+=*DS_Store*
    set wildignore+=*.gem
    set wildignore+=log/**
    set wildignore+=tmp/**
    set wildignore+=*.png,*.jpg,*.gif

" === Performance ===
    set lazyredraw " Fix slow scrolling that occurs when using mouse and relative numbers

" === File Management ===
    set noswapfile
    set nobackup
    set nowritebackup " Some servers (coc.vim) have issues with backup files
    set nowb
    set autoread
    " Triger `autoread` when files changes on disk
    autocmd FocusGained,BufEnter,CursorHold,CursorHoldI * if mode() != 'c' | checktime | endif
    " Notification after file change
    autocmd FileChangedShellPost *
    \ echohl WarningMsg | echo "File changed on disk. Buffer reloaded." | echohl None

" === Scrolling ===
    set scrolloff=8 " Start scrolling when we're 8 lines away from margins

" === Keyboard bindings ===
    let mapleader = " "
    :nmap <Space> :
    
    " === vim-easy-align ===
    " Start interactive EasyAlign in visual mode (e.g. vipga): get-aligned
    xmap ga <Plug>(EasyAlign)
    " Start interactive EasyAlign for a motion/text object (e.g. gaip)
    nmap ga <Plug>(EasyAlign)
    
    " === coc.vim ===
    " To make snippet completion work just like VSCode
    " https://github.com/neoclide/coc.nvim/wiki/Using-snippets
    " <<< Install coc-snippets for this
    inoremap <silent><expr> <TAB>
          \ pumvisible() ? coc#_select_confirm() :
          \ coc#expandableOrJumpable() ? "\<C-r>=coc#rpc#request('doKeymap', ['snippets-expand-jump',''])\<CR>" :
          \ <SID>check_back_space() ? "\<TAB>" :
          \ coc#refresh()
    function! s:check_back_space() abort
      let col = col('.') - 1
      return !col || getline('.')[col - 1]  =~# '\s'
    endfunction

    let g:coc_snippet_next = '<tab>'

    " Close preview window when completion is done
    autocmd! CompleteDone * if pumvisible() == 0 | pclose | endif

    " https://github.com/rstacruz/vim-coc-settings/blob/master/after/plugin/coc.vim
    " gd - go to definition of word under cursor
    nmap <silent> gd <Plug>(coc-definition)
    nmap <silent> gy <Plug>(coc-type-definition)

    " gi - go to implementation
    nmap <silent> gi <Plug>(coc-implementation)

    " gr - find references
    nmap <silent> gr <Plug>(coc-references)

    " gh - get hint on whatever's under the cursor
    nnoremap <silent> K :call <SID>show_documentation()<CR>
    nnoremap <silent> gh :call <SID>show_documentation()<CR>
    function! s:show_documentation()
      if &filetype == 'vim'
        execute 'h '.expand('<cword>')
      else
        call CocAction('doHover')
      endif
    endfunction

    nnoremap <silent> <leader>co  :<C-u>CocList outline<cr>
    nnoremap <silent> <leader>cs  :<C-u>CocList -I symbols<cr>
    " List errors
    nnoremap <silent> <leader>cl  :<C-u>CocList locationlist<cr>
    " List commands available in tsserver (and others)
    nnoremap <silent> <leader>cc  :<C-u>CocList commands<cr>
    " Restart when tsserver gets wonky
    nnoremap <silent> <leader>cR  :<C-u>CocRestart<CR>
    nnoremap <silent> <leader>cl  :<C-u>CocList locationlist<CR>
    " Manage extensions
    nnoremap <silent> <leader>cx  :<C-u>CocList extensions<cr>
    " Rename the current word in the cursor
    nmap <leader>cr  <Plug>(coc-rename)
    nmap <leader>cf  <Plug>(coc-format-selected)
    vmap <leader>cf  <Plug>(coc-format-selected)
    " Run code actions
    vmap <leader>ca  <Plug>(coc-codeaction-selected)
    nmap <leader>ca  <Plug>(coc-codeaction-selected)

    " === Some of my fav spacemacs bindings ===
    " Close buffer in focus: buffer-delete
    nnoremap <leader>bd <C-w>q
    nnoremap <leader>bn :w<CR>:bn<CR> 
    " Splits
    nnoremap <leader>vs :vsplit<CR>
    nnoremap <leader>hs :split<CR>

    " Move between buffers
    nnoremap <leader>wh <C-w>h 
    nnoremap <leader>wj <C-w>j
    nnoremap <leader>wk <C-w>k
    nnoremap <leader>wl <C-w>l

    " === tmux ===
    " Write all buffers before navigating from Vim to tmux pane
    let g:tmux_navigator_save_on_switch = 2

    " === Nerd Tree ===
    " Toggle NERDTree: fi-letree
    nnoremap <leader>fi :NERDTreeToggle<CR>
    " Close vim if only window left is NERDTree
    autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif

    " === Goyo ===
    " Toggle Goyo: distraction-free
    nnoremap <leader>df :Goyo<CR> 

    " === Vim terminal emulator ===
    " Open a terminal 
    nnoremap <leader>' :let $VIM_DIR=expand('%:p:h')<CR> :8sp term://zsh<CR>cd $VIM_DIR<CR>
    " Move to normal mode in terminal
    tnoremap <ESC> <C-\><C-n>

    " === C++ ===
    " Compile current file: compile
    autocmd FileType cpp,c,objc nmap <buffer> <leader>cm :w <CR> :!g++ -std=c++17 % -o %<.exe && ./%<.exe <CR>

    " === Misc ===
    " Remove highlighting after search: highlighting-off
    nnoremap <leader>ho :noh<CR>
    " Open this file: vim-options 
    nnoremap <leader>vo :e ~/.config/nvim/init.vim<CR>
    " Reload config file 
    nnoremap <C-s> :w<CR>:source ~/.config/nvim/init.vim<CR>

" === Plugin Settings ===
    " === vim-airline ===
    " Airline + Tabline
    let g:airline#extensions#tabline#enabled = 1
    " Use fancy fonts
    let g:airline_powerline_fonts = 1
    " Move statusline to the top - Good for Tmux as it has it's own line
    let g:airline_statusline_ontop=1
    let g:airline#extensions#whitespace#enabled = 0
    " Airline + Ale
    let g:airline#extensions#ale#enabled = 1 
    " Remove file encoding
    let g:airline_section_y='' 
    " Remove line column number and simplify last section
    let g:airline_section_z = airline#section#create(['%3l:%3v'])
    " Remove separators for empty sections
    let g:airline_skip_empty_sections = 1

    " Remove vim's default ugly statusline that remains at the bottom
    " https://unix.stackexchange.com/questions/140898/vim-hide-status-line-in-the-bottom
    let s:hidden_all = 0
    function! TogglehiddenAll()
        if s:hidden_all == 0
            let s:hidden_all = 1
            set noshowmode
            set noruler
            set laststatus=0
            set noshowcmd
        else
            let s:hidden_all = 0
            set showmode
            set ruler
            set laststatus=2
            set showcmd
        endif
    endfunction
    " statusline-hide
    nnoremap <leader>sh :call TogglehiddenAll()<CR>
    " TODO: If hidden_all == 0 call TogglehiddenAll() on startup & GoyoEnter/Leave

    " === vim-airline-themes ===
    let g:airline_theme = 'minimalist' 

    " === nerd-commenter ===
    " Add spaces after comment delimiters by default
    let g:NERDSpaceDelims = 1
    " Use compact syntax for prettified multi-line comments
    let g:NERDCompactSexyComs = 1
    " Align line-wise comment delimiters flush left instead of following code indentation
    let g:NERDDefaultAlign = 'left'
    " Set a language to use its alternate delimiters by default
    let g:NERDAltDelims_java = 1
    " Add your own custom formats or override the defaults
    let g:NERDCustomDelimiters = { 'c': { 'left': '/**','right': '*/' } }
    " Allow commenting and inverting empty lines (useful when commenting a region)
    let g:NERDCommentEmptyLines = 1
    " Enable trimming of trailing whitespace when uncommenting
    let g:NERDTrimTrailingWhitespace = 1
    " Enable NERDCommenterToggle to check all selected lines is commented or not 
    let g:NERDToggleCheckAllLines = 1

    " === nerd-tree ===
    let NERDTreeShowLineNumbers=0

    " === goyo ===
    let g:goyo_width='96%'
    let g:goyo_height='96%'
    function! s:goyo_enter()
        set scrolloff=999
    endfunction

    function! s:goyo_leave()
        set noshowmode
        set noruler
        set laststatus=0
        set noshowcmd
        set scrolloff=5
    endfunction

    autocmd! User GoyoEnter nested call <SID>goyo_enter()
    autocmd! User GoyoLeave nested call <SID>goyo_leave()

    " === auto-pairs ===
    " This uses <leader> in insert mode making vim a stuttering mess 
    let g:AutoPairsMapSpace = "false"

    "" === vim-easytags ===
    "let g:easytags_async = 1
    "let g:easytags_file = '~/.vim/tags'
    "" Project specific tag files
    "set tags=./tags;
    "let g:easytags_dynamic_files=0

    " === ale ===
    " C++
    let g:ale_cpp_gcc_executable='gcc-9'
    let g:ale_cpp_gcc_options='-std=c++17 -Wextra -Wall'

    let g:ale_cpp_clang_executable='clang++'
    let g:ale_cpp_clang_options='-std=c++17 -Wextra -Wall'
    
    let g:ale_linters = {
                \'cpp': ['gcc', 'clang-tidy'],
                \}

    " === coc-snippets ===
    " https://github.com/neoclide/coc-snippets/issues/15#issuecomment-475891282
    " Use `:CocCommand snippets.ediSnippets` to open the snippet file for the current filetype
    " All snippets for the current filetype live there

